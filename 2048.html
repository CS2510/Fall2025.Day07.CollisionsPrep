<!doctype html>
<html>

<head>
  <title>Day 06 Game</title>
  <style>
    * {
      margin: 0;
      overflow: hidden;
    }
  </style>

</head>

<body>
  <canvas id="canv"></canvas>
  <!-- Engine-specific Code -->
  <script src="./engine/Vector2.js"></script>
  <script src="./engine/Scene.js"></script>
  <script src="./engine/GameObject.js"></script>
  <script src="./engine/Component.js"></script>
  <script src="./engine/Input.js"></script>
  <script src="./engine/Engine.js"></script>
  <script src="./engine/Time.js"></script>

  <script src="./engine/components/Transform.js"></script>
  <script src="./engine/components/Polygon.js"></script>

  <script>
    class MainScene extends Scene {
      constructor() {
        super()
        this.instantiate(new EmptySquareGameObject, new Vector2(50, 50))
        this.instantiate(new EmptySquareGameObject, new Vector2(50, 150))
        this.instantiate(new EmptySquareGameObject, new Vector2(50, 250))
        this.instantiate(new EmptySquareGameObject, new Vector2(50, 350))

        this.instantiate(new EmptySquareGameObject, new Vector2(150, 50))
        this.instantiate(new EmptySquareGameObject, new Vector2(150, 150))
        this.instantiate(new EmptySquareGameObject, new Vector2(150, 250))
        this.instantiate(new EmptySquareGameObject, new Vector2(150, 350))

        this.instantiate(new EmptySquareGameObject, new Vector2(250, 50))
        this.instantiate(new EmptySquareGameObject, new Vector2(250, 150))
        this.instantiate(new EmptySquareGameObject, new Vector2(250, 250))
        this.instantiate(new EmptySquareGameObject, new Vector2(250, 350))

        this.instantiate(new EmptySquareGameObject, new Vector2(350, 50))
        this.instantiate(new EmptySquareGameObject, new Vector2(350, 150))
        this.instantiate(new EmptySquareGameObject, new Vector2(350, 250))
        this.instantiate(new EmptySquareGameObject, new Vector2(350, 350))

        this.instantiate(new ControllerGameObject())
      }
    }

    class EmptySquareGameObject extends GameObject {
      constructor() {
        super("Empty Square")
        this.addComponent(new Polygon, { fillStyle: "gray", points: [new Vector2(-1, -1), new Vector2(-1, 1), new Vector2(1, 1), new Vector2(1, -1)] })
        this.transform.scale = new Vector2(45, 45)
      }
    }

    class ControllerGameObject extends GameObject {
      constructor() {
        super("Controller Game Object")
        this.addComponent(new Controller())
      }
    }

    class BlockGameObject extends GameObject {
      constructor() {
        super("Block Game Object")
        this.addComponent(new Polygon, { fillStyle: "green", points: [new Vector2(-1, -1), new Vector2(-1, 1), new Vector2(1, 1), new Vector2(1, -1)] })
        this.addComponent(new TextComponent(), { fillStyle: "white", text: "2" })
        this.addComponent(new BlockController())
        this.transform.scale = new Vector2(45, 45)
      }
    }

    function randomIndex() {
      return Math.floor(Math.random() * 4)
    }

    function getRandomOpenSpot() {
      const currentBlocks = Engine.currentScene.gameObjects.filter(go => go.name == "Block Game Object")
      if (currentBlocks.length == 16) return null
      let randomIndexPair
      let tries = 0
      do {
        tries++
        randomIndexPair = [randomIndex(), randomIndex()]
      } while (tries < 1000 && currentBlocks.find(b => b.getComponent(BlockController).indexX == randomIndexPair[0] && b.getComponent(BlockController).indexY == randomIndexPair[1]))
      if (tries == 1000)
        console.error("Hit max tries")
      return randomIndexPair

    }

    class Controller extends Component {
      started = false
      moving = false
      movingUntil = -1
      canAddBlock = false
      start() {
        this.elapsedTime = 0
      }
      update() {
        if (!this.started) {
          this.started = true
          //Generate some random blocks
          for (let i = 0; i < 2; i++) {
            let location = getRandomOpenSpot()
            let block = new BlockGameObject()
            block.getComponent(BlockController).indexX = location[0]
            block.getComponent(BlockController).indexY = location[1]
            block.getComponent(BlockController).number = (i + 1) * 2
            block.transform.position = new Vector2(location[0] * 100 + 50, location[1] * 100 + 50)
            block.transform.scale = Vector2.zero

            Engine.currentScene.instantiate(block)

          }
        }
        this.elapsedTime += Time.deltaTime

        const currentBlocks = Engine.currentScene.gameObjects.filter(go => go.name == "Block Game Object")
        if (currentBlocks.length == 16) {
          return
        }


        if (this.moving) {
          if (this.movingUntil <= this.elapsedTime)
            this.moving = false
        }
        let offset = Vector2.zero
        if (!this.moving) {
          if (this.canAddBlock) {
            this.canAddBlock = false
            let location = getRandomOpenSpot()
            let block = new BlockGameObject()
            block.getComponent(BlockController).indexX = location[0]
            block.getComponent(BlockController).indexY = location[1]
            block.getComponent(BlockController).number = Math.random() < .5 ? 2 : 4
            block.transform.position = new Vector2(location[0] * 100 + 50, location[1] * 100 + 50)
            block.transform.scale = Vector2.zero

            Engine.currentScene.instantiate(block)
          }
          if (Input.keysDown.includes("ArrowUp")) offset = Vector2.up
          if (Input.keysDown.includes("ArrowDown")) offset = Vector2.down
          if (Input.keysDown.includes("ArrowLeft")) offset = Vector2.left
          if (Input.keysDown.includes("ArrowRight")) offset = Vector2.right

        }
        if (offset.x != 0 || offset.y != 0) {
          let didSomethingMove = false
          for (let i = 0; i < 4; i++) {
            let filter
            if (offset.x == -1) filter = block => block.getComponent(BlockController).indexX == i
            if (offset.x == 1) filter = block => block.getComponent(BlockController).indexX == 3 - i
            if (offset.y == -1) filter = block => block.getComponent(BlockController).indexY == i
            if (offset.y == 1) filter = block => block.getComponent(BlockController).indexY == 3 - i
            const filteredBlocks = currentBlocks.filter(filter)
            for (const block of filteredBlocks) {
              let didChange = true
              let count = 0
              while (didChange && count < 1000) {
                didChange = false
                const currentIndex = [block.getComponent(BlockController).indexX, block.getComponent(BlockController).indexY]
                if (currentIndex[0] == 0 && offset.x == -1) continue
                if (currentIndex[0] == 3 && offset.x == 1) continue
                if (currentIndex[1] == 0 && offset.y == -1) continue
                if (currentIndex[1] == 3 && offset.y == 1) continue
                const collisionBlock = currentBlocks.find(b =>
                  b != block &&
                  b.getComponent(BlockController).indexX == currentIndex[0] + offset.x &&
                  b.getComponent(BlockController).indexY == currentIndex[1] + offset.y &&
                  !b.markForDelete
                )
                if (collisionBlock) {
                  if (collisionBlock.getComponent(BlockController).number == block.getComponent(BlockController).number) {
                    block.destroy()
                    collisionBlock.getComponent(BlockController).number *= 2
                    didSomethingMove = true
                  }
                  continue
                }
                didSomethingMove = true
                didChange = true
                block.getComponent(BlockController).indexX += offset.x
                block.getComponent(BlockController).indexY += offset.y
              }
              if(count >= 1000){
                console.error("Too many attempts")
              }
            }

          }

          this.moving = true
          this.movingUntil = this.elapsedTime + .5
          if (didSomethingMove) {
            console.log("Something moved)")
            this.canAddBlock = true
          }


        }
      }
    }

    class TextComponent extends Component {
      fillStyle = "magenta"
      text = "NO TEXT"
      font = "20px Arial"
      draw(ctx) {
        ctx.fillStyle = this.fillStyle
        ctx.font = this.font
        ctx.fillText(this.text, this.transform.position.x, this.transform.position.y)
      }
    }

    class BlockController extends Component {
      start() {
      }
      update() {
        this.gameObject.getComponent(TextComponent).text = this.number
        const goalLocation = [this.indexX * 100 + 50, this.indexY * 100 + 50]
        const factor = .9
        this.transform.position = new Vector2(factor * this.transform.position.x + (1 - factor) * goalLocation[0], factor * this.transform.position.y + (1 - factor) * goalLocation[1],)
        this.transform.scale = new Vector2(factor * this.transform.scale.x + (1 - factor) * 45, factor * this.transform.scale.y + (1 - factor) * 45)
      }
    }




    Engine.currentScene = new MainScene()
    Engine.start()
  </script>
</body>

</html>